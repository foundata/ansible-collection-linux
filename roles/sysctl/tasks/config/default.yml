# Configuration: Manage sysctl kernel parameters.
#
# This file contains the core logic for setting sysctl parameters using
# the ansible.posix.sysctl module.

---

- name: "Config | Default | Ensure drop-in config directory exists with proper permissions"
  ansible.builtin.file:
    path: "{{ __sysctl_linux_config_dropin_dir_path }}"
    state: "directory"
    owner: "{{ __sysctl_linux_config_dropin_dir_owner }}"
    group: "{{ __sysctl_linux_config_dropin_dir_group }}"
    mode: "{{ __sysctl_linux_config_dropin_dir_mode }}"


- name: "Config | Default | Ensure drop-in config file exists with proper permissions"
  ansible.builtin.file:
    path: "{{ __sysctl_linux_config_dropin_file_path }}"
    state: "touch"
    owner: "{{ __sysctl_linux_config_dropin_file_owner }}"
    group: "{{ __sysctl_linux_config_dropin_file_group }}"
    mode: "{{ __sysctl_linux_config_dropin_file_mode }}"
    access_time: "preserve"
    modification_time: "preserve"


- name: "Config | Default | Remove default drop-in config file (if custom filename is used)"
  ansible.builtin.file:
    path: "{{ __sysctl_linux_config_dropin_file_path_default }}"
    state: "absent"
  when:
    - __sysctl_linux_config_dropin_file_path != __sysctl_linux_config_dropin_file_path_default
  notify:
    - "sysctl_linux: reload"


# No Jinja template file but ansible.posix.sysctl is used below, so {{ ansible_managed }}
# cannot be applied. The header is therefore managed explicitly by a task.
- name: "Config | Default | Ensure 'Ansible managed' header in sysctl drop-in config file"
  ansible.builtin.lineinfile:
    path: "{{ __sysctl_linux_config_dropin_file_path }}"
    regexp: '(?i)^#\s+ansible\s+managed'
    line: "# Ansible managed (ATTENTION: manual changes will be discarded)"
    insertbefore: "BOF"
    state: "present"


- name: "Config | Default | Read current sysctl drop-in file"
  ansible.builtin.slurp:
    src: "{{ __sysctl_linux_config_dropin_file_path }}"
  register: __sysctl_linux_dropin_file_content
  failed_when: false


- name: "Config | Default | Parse existing parameters from drop-in file"
  ansible.builtin.set_fact:
    __sysctl_linux_existing_parameters: >-
      {{
        (__sysctl_linux_dropin_file_content['content'] | default('') | ansible.builtin.b64decode)
        .split('\n')
        | reject('match', '^\s*#')
        | reject('match', '^\s*$')
        | ansible.builtin.map('regex_replace', '\s*=\s*', '=')
        | ansible.builtin.map('regex_search', '^([^=]+)=')
        | select('string')
        | ansible.builtin.map('regex_replace', '=$', '')
        | ansible.builtin.list
      }}


- name: "Config | Default | Set sysctl drop-in parameters"
  ansible.posix.sysctl:
    name: "{{ item['key'] }}"
    value: "{{ item['value'] }}"
    state: "present"
    sysctl_file: "{{ __sysctl_linux_config_dropin_file_path }}"
    # fail if parameter is invalid or read-only
    sysctl_set: "{{ sysctl_linux_verify | default(omit) }}"
    # reloading will be done by handler, following precedence
    reload: false
    ignoreerrors: "{{ sysctl_linux_ignore_unknown_key_errors | default(omit) }}"
  loop: "{{ __sysctl_linux_effective_parameters | dict2items }}"
  loop_control:
    # human-friendly output like "item=net.ipv4.ip_forward=1"
    label: "{{ item['key'] }}={{ item['value'] }}"
  when:
    - __sysctl_linux_effective_parameters | ansible.builtin.length > 0
    # none (Python / Ansible) == null (YAML)
    - item['value'] is not none
    - item['value'] | string | ansible.builtin.length > 0
  notify:
    - "sysctl_linux: reload"


- name: "Config | Default | Build list of sysctl drop-in parameters to remove from config"
  ansible.builtin.set_fact:
    # Combines orphaned parameters (in file but not in effective params) with
    # explicit removals (value is null or empty string, e.g. to override profiles)
    __sysctl_linux_parameters_remove: >-
      {{
        (
          __sysctl_linux_existing_parameters
          | difference(__sysctl_linux_effective_parameters.keys() | ansible.builtin.list)
        ) + (
          __sysctl_linux_effective_parameters
          | dict2items
          | selectattr('value', 'in', [none, ''])
          | ansible.builtin.map(attribute='key')
          | ansible.builtin.list
        )
        | ansible.builtin.unique
      }}


- name: "Config | Default | Remove sysctl drop-in parameters marked for deletion from config"
  ansible.posix.sysctl:
    name: "{{ item }}"
    state: "absent"
    sysctl_file: "{{ __sysctl_linux_config_dropin_file_path }}"
    # reloading will be done by handler, following precedence
    reload: false
    ignoreerrors: "{{ sysctl_linux_ignore_unknown_key_errors | default(omit) }}"
  loop: "{{ __sysctl_linux_parameters_remove }}"
  loop_control:
    # human-friendly output like "item=net.ipv4.ip_forward (remove)"
    label: "{{ item }} (remove)"
  when:
    - __sysctl_linux_parameters_remove | ansible.builtin.length > 0
  notify:
    - "sysctl_linux: reload"


- name: "Config | Default | Check if main config file exists"
  ansible.builtin.stat:
    path: "{{ __sysctl_linux_config_file_path }}"
  register: __sysctl_linux_config_file_stat


- name: "Config | Default | Build list of sysctl drop-in parameters that should take precedence"
  ansible.builtin.set_fact:
    __sysctl_linux_parameters_comment: >-
      {{
        sysctl_linux_parameters
        | dict2items
        | selectattr('value', 'ne', none)
        | rejectattr('value', 'equalto', '')
        | ansible.builtin.map(attribute='key')
        | ansible.builtin.map('regex_escape')
        | ansible.builtin.list
      }}
  when:
    - __sysctl_linux_config_file_stat['stat']['exists'] | default(false)


# Remember: It is possible to overwrite values, last occurrence wins.
- name: "Config | Default | Comment out duplicates in main config file (if any) to ensure drop-in config precedence"
  ansible.builtin.replace:
    path: "{{ __sysctl_linux_config_file_path }}"
    # Notes on the regex:
    # - ({{ __sysctl_linux_parameters_comment | join('|') }}) will result in something like
    #   vm\.swappiness|net\.ipv4\.ip_forward (escaping is done )
    # - When options are joined with '|', an empty (whitespace-only) option would
    #   produce patterns like 'foo||bar', where '||' matches an empty string at any
    #   position. The 'select' filter prevents this.
    # - (?=\s*(?:=|\s|$)) is a safeguard to prevent partial-key matches (e.g.,
    #   'net.ipv4.foo' accidentally matching 'net.ipv4.foobar_baz').
    #   The expression is compatible with the obvious
    #     net.ipv4.foo=5
    #     net.ipv4.foo = 5
    #   and non-obvious
    #     net.ipv4.foo
    #   syntax (without value is valid and means "set to kernel default" or
    #   "query value", depending on context).
    regexp: >-
      ^(?![\t ]*#)([\t ]*)({{ __sysctl_linux_parameters_comment | select | join('|') }})(?=\s*(?:=|\s|$))(.*)
    replace: '#\1\2\3'
  when:
    - __sysctl_linux_config_file_stat['stat']['exists'] | default(false)
    - __sysctl_linux_parameters_comment | ansible.builtin.length > 0
  notify:
    - "sysctl_linux: reload"
