# Role argument validation.
#
# See defaults/main.yml for details on each variable. For more information on
# the argument_specs.yml format, refer to the official Ansible documentation:
# https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html#role-argument-validation

---

argument_specs:

  # foundata.linux/roles/run/tasks/main.yml entry point
  main:
    short_description: "Main entry point for the foundata.linux.sysctl role"
    options:

      sysctl_linux_state:
        description: |
          Determines whether the managed resources should be `present` or `absent`.

          `present` ensures that required components, such as software packages, are
          installed and configured.

          `absent` reverts changes as much as possible, such as removing packages,
          deleting created users, stopping services, restoring modified settings, â€¦

          Note: For this role, the required component and package set is minimal. There
          are no users or services to manage and the components needed to set kernel
          parameter are preinstalled even on hardened systems. They also cannot be
          safely removed due to dependencies, so the role rarely modifies the system
          in this regard.
        type: "str"
        default: "present"
        choices:
          - "present"
          - "absent"

      sysctl_linux_autoupgrade:
        description: |
          If set to `true`, all managed packages will be upgraded during each Ansible
          run (e.g., when the package provider detects a newer version than the
          currently installed one).
        type: "bool"
        default: false

      sysctl_linux_profile:
        description: |
          Selects a predefined set of kernel parameters optimized for a specific workload.
          Each profile provides tuned values for network, memory, I/O, and security settings.
          Some values are auto-calculated based on system resources (RAM, CPU cores) to
          fit the target system. All profiles include security best practices such as
          source validation, ICMP hardening, and filesystem protections.

          Use `sysctl_linux_parameters` to override any profile value if needed for your
          specific use-case.

          Possible values:

          - '' (empty string): No tuning applied. Only explicit `sysctl_linux_parameters` are set.
          - `web`: High connection count and throughput. Recommended for web servers,
            API gateways, load balancers, reverse proxies.
            See [`web.md`](../vars/profiles/web.md) for details.
          - `database`: Memory management, shared memory, low swappiness, I/O tuning.
            Recommended for PostgreSQL, MySQL, Redis, Elasticsearch.
            See [`database.md`](../vars/profiles/database.md) for details.
          - `file`: Network throughput and storage I/O. Recommended for fileservers (NFS,
            Samba, SFTP) backup targets ad their like. See [`file.md`](../vars/profiles/file.md)
            for details.
          - `virtualization`: Memory overcommit, scheduler tuning, storage I/O.
            Recommended for KVM/QEMU hosts, Proxmox.
            See [`virtualization.md`](../vars/profiles/virtualization.md) for details.
          - `router`: Connection tracking, neighbor tables, IP forwarding (IPv4 + IPv6).
            Recommended for firewalls, NAT gateways, VPN concentrators.
            See [`router.md`](../vars/profiles/router.md) for details.
          - `router_v4only`: Like `router` but enables IPv4 forwarding only and
            explicitly disables IPv6 forwarding.
            See [`router_v4only.md`](../vars/profiles/router_v4only.md) for details.
          - `router_v6only`: Like `router` but enables IPv6 forwarding only and
            explicitly disables IPv4 forwarding.
            See [`router_v6only.md`](../vars/profiles/router_v6only.md) for details.
        type: "str"
        default: ""
        choices:
          - ""
          - "web"
          - "database"
          - "file"
          - "virtualization"
          - "router"
          - "router_v4only"
          - "router_v6only"

      sysctl_linux_parameters:
        description: |
          Dictionary of kernel parameters to manage via sysctl. Keys are parameter
          names (e.g., `net.ipv4.ip_forward`), values are the desired settings.

          Setting a value to `null` or an empty string removes the parameter from
          the managed drop-in configuration file, reverting to the kernel default.

          These parameters take precedence over any values set by `sysctl_linux_profile`
          (if any). This allows using a profile as a baseline while customizing specific
          values.

          Example:

          ```yaml
          sysctl_linux_parameters:
            "net.ipv4.ip_forward": null  # use kernel default, remove from config
            "vm.swappiness": 5
          ```

          Example overriding a profile value:

          ```yaml
          sysctl_linux_profile: "database"
          sysctl_linux_parameters:
            "vm.swappiness": 1  # override database profile default
          ```
        type: "dict"
        required: true

      sysctl_linux_reload:
        description: |
          If set to `true`, triggers `sysctl --system` after configuration changes
          to reload all sysctl configuration files following the proper precedence
          order. This ensures all drop-in files and possibly existing other sysctl
          configuration files not managed by this role are applied consistently.

          Set to `false` in container environments where `sysctl --system` may fail
          due to read-only kernel parameters.
        type: "bool"
        default: true

      sysctl_linux_verify:
        description: |
          If set to `true`, verifies the parameter value using the sysctl command
          and actively sets it in the running kernel using `sysctl -w` if the
          current value differs from the desired one.

          When `false`, only writes the parameter to the configuration file without
          verifying or immediately applying it to the running kernel.
        type: "bool"
        default: true

      sysctl_linux_ignore_unknown_key_errors:
        description: |
          If set to `true`, ignores errors caused by unknown or unsupported kernel
          parameter keys. This is useful in container environments where certain
          parameters may not exist or be accessible.

          Generally not recommended for bare-metal or VM deployments where all
          expected parameters should be available.
        type: "bool"
        default: false

      sysctl_linux_config_dropin_file_name:
        description: |
          Filename of the drop-in configuration file to be placed in `/etc/sysctl.d/`.
          Defaults to `90-managed.conf`. The `90-` prefix ensures late loading and thus
          higher precedence over files with lower-numbered prefixes.

          If a non-default filename is used, any existing `/etc/sysctl.d/90-managed.conf`
          from previous Ansible runs will be removed automatically to prevent conflicts.
        type: "str"
        default: "90-managed.conf"