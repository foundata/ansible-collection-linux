# Handlers: Tasks that are triggered and run only when notified.

---

- name: "Handlers | Reload all kernel parameters (following precedence) (sysctl --system)"
  # Using command module because ansible.posix.sysctl only reloads individual
  # parameters, while "sysctl --system" reloads all configuration files in the
  # following list in given order from top to bottom (while last read files
  # and values can overwrite previously defined things), cf. man sysctl(8):
  #
  # - /etc/sysctl.d/*.conf
  # - /run/sysctl.d/*.conf
  # - /usr/local/lib/sysctl.d/*.conf
  # - /usr/lib/sysctl.d/*.conf
  # - /lib/sysctl.d/*.conf
  # - /etc/sysctl.conf
  #
  # As /etc/sysctl.conf is read last, it can replace/override any parameters
  # previously set in files in the listed directories.
  ansible.builtin.command:
    argv:
      - "{{ __sysctl_linux_sysctl_executable }}"
      - "--system"
  when:
    - sysctl_linux_reload
  # There is no sane way to check for changes when loading all values. However,
  # this is acceptable as this handler only get's triggered on change.
  changed_when: false # FIXME noqa ansible lint
  failed_when:
    - __sysctl_reload_result is failure
    - not __sysctl_linux_is_container # best effort in containers
  register: __sysctl_reload_result
  listen:
    - "sysctl_linux: reload"


- name: "Handlers | Log failed sysctl reload attempt (due to read-only params in containerized systems)"
  ansible.builtin.debug:
    msg: >-
      sysctl --system attempted in container (rc={{ __sysctl_reload_result['rc'] }}; failures tolerated).
      stdout={{ (__sysctl_reload_result['stdout'] | ansible.builtin.default('') | ansible.builtin.trim) | ansible.builtin.regex_replace('\n+', ' | ') }}
      stderr={{ (__sysctl_reload_result['stderr'] | ansible.builtin.default('') | ansible.builtin.trim) | ansible.builtin.regex_replace('\n+', ' | ') }}
    verbosity: 3
  changed_when: false
  when:
    - sysctl_linux_reload
    - __sysctl_linux_is_container
    - __sysctl_reload_result is defined
    - __sysctl_reload_result['rc'] != 0 # comparing rc; failure test masked in containers in the previous handle
  listen:
    - "sysctl_linux: reload"
